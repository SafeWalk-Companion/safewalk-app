name: 'Test SafeWalk.WebAPI'
description: 'Runs XUnit tests for the SafeWalk.WebAPI .NET solution'
inputs:
  dotnet-version:
    description: 'The .NET SDK version to use'
    required: false
    default: '9.0.x'
  configuration:
    description: 'Build configuration (Debug or Release)'
    required: false
    default: 'Release'
  solution-path:
    description: 'Path to the solution file'
    required: false
    default: 'Backend/SafeWalk.WebAPI/SafeWalk.WebAPI.sln'
  test-project-path:
    description: 'Path to the test project'
    required: false
    default: 'Backend/SafeWalk.WebAPI/SafeWalk.WebAPI.Core.Tests/SafeWalk.WebAPI.Core.Tests.csproj'
outputs:
  test-status:
    description: 'Test status (success or failure)'
    value: ${{ steps.test.outputs.status }}
runs:
  using: 'composite'
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Display .NET version
      shell: bash
      run: dotnet --version

    - name: Restore dependencies
      shell: bash
      run: |
        echo "Restoring NuGet packages for ${{ inputs.solution-path }}..."
        dotnet restore "${{ inputs.solution-path }}"

    - name: Build solution
      shell: bash
      run: |
        echo "Building ${{ inputs.solution-path }} in ${{ inputs.configuration }} configuration..."
        dotnet build "${{ inputs.solution-path }}" \
          --configuration ${{ inputs.configuration }} \
          --no-restore \
          --verbosity minimal

    - name: Run tests
      id: test
      shell: bash
      run: |
        echo "Running XUnit tests for ${{ inputs.test-project-path }}..."
        if dotnet test "${{ inputs.test-project-path }}" \
          --configuration ${{ inputs.configuration }} \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results.trx" \
          --logger "console;verbosity=detailed" \
          --collect:"XPlat Code Coverage"; then
          echo "Tests passed!"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "Tests failed!"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: "**/TestResults/**/*.trx"
        retention-days: 30

    - name: Upload code coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-coverage
        path: "**/TestResults/**/coverage.cobertura.xml"
        retention-days: 30
